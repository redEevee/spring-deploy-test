name: Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  build:
    name: build-app
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Create .env for CD Deploy
        run: echo "${{ secrets.PRODUCTION_ENV }}" > .env

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (GITHUB_TOKEN)
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      # owner를 소문자로 만들고 표준 태그 생성
      - name: Set image tag (lowercase owner)
        id: meta
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE="ghcr.io/${OWNER_LC}/spring-backend:latest"
          echo "DOCKER_IMAGE=${IMAGE}" >> $GITHUB_ENV
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

      - name: Build & Push (multi-arch)
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -f Dockerfile \
            -t "${DOCKER_IMAGE}" \
            --push .

  deploy:
    needs: build
    name: Deploy
    runs-on: [self-hosted, deploy-spring-test]
    env:
      DOCKER_IMAGE: ${{ needs.build.outputs.image }}
    steps:
      - name: Ensure Docker & Compose installed
        shell: bash
        run: |
          set -e
          if ! command -v docker >/dev/null 2>&1; then
            echo "[+] Installing Docker/Compose..."
            source /etc/os-release || true
            if [[ "$ID" == "amzn" && "$VERSION_ID" == "2023" ]]; then
              sudo dnf -y update
              sudo dnf -y install docker docker-compose-plugin
              sudo systemctl enable --now docker
            elif [[ "$ID" == "amzn" ]]; then
              sudo yum -y update
              sudo amazon-linux-extras install -y docker
              sudo systemctl enable --now docker
              # Compose v2 바이너리 대체 (AL2 호환)
              if ! command -v docker-compose >/dev/null 2>&1 && ! docker compose version >/dev/null 2>&1; then
                sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.7/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                sudo chmod +x /usr/local/bin/docker-compose
              fi
            elif [[ "$ID" == "ubuntu" ]]; then
              sudo apt-get update -y
              sudo apt-get install -y docker.io docker-compose-plugin
              sudo systemctl enable --now docker
            else
              echo "Unsupported OS: $ID $VERSION_ID"; exit 1
            fi
          fi

          echo "[i] Docker version:"
          sudo docker --version || true
          echo "[i] Docker Compose version:"
          if sudo docker compose version >/dev/null 2>&1; then
            sudo docker compose version
          elif command -v docker-compose >/dev/null 2>&1; then
            docker-compose version
          else
            echo "Compose not found after install"; exit 1
          fi

          # 현재 러너 계정을 도커 그룹에 추가(다음 실행부터 sudo 없이 가능)
          if id -nG "$USER" | grep -qw docker; then
            echo "[i] User already in docker group"
          else
            sudo usermod -aG docker "$USER" || true
          fi

      - name: Deploy to Production
        shell: bash
        run: |
          set -e
          echo "Starting Backend Production Deployment"
          cd /home/ec2-user/spring-deploy-test

          # Compose v2 우선, 없으면 v1 사용
          if sudo docker compose version >/dev/null 2>&1; then
            COMPOSE_CMD="sudo docker compose"
          else
            COMPOSE_CMD="sudo docker-compose"
          fi

          $COMPOSE_CMD down || true

          # GHCR pull (PAT 필요: read:packages 이상)
          echo "${{ secrets.GHCR_TOKEN }}" | sudo docker login ghcr.io -u ${{ secrets.GHCR_ACTOR }} --password-stdin

          sudo docker pull "${DOCKER_IMAGE}"
          sudo docker image prune -f
          sudo docker logout

          $COMPOSE_CMD up -d
